<html lang=en>
<title>File manager</title>
<style media=screen>
  body {
	font-size: 12px;
	font-family: Verdana, Arial, Sans-serif
}

.contextMenu {
	z-index: 300;
	position: absolute;
	left: 5px;
	border: 1px solid #444;
	background-color: #f5f5f5;
	display: none;
	box-shadow: 0 0 10px rgba(0, 0, 0, .4);
	font-size: 11px;
	font-weight: 700
}

.contextMenu ul {
	list-style: none;
	top: 0;
	left: 0;
	margin: 0;
	padding: 0
}

.contextMenu li {
	position: relative;
	min-width: 60px;
	cursor: pointer
}

.contextMenu span {
	color: #444;
	display: inline-block;
	padding: 6px
}

.contextMenu li:hover {
	background: #444
}

.contextMenu li:hover span {
	color: #eee
}

.css-treeview li,
.css-treeview ul {
	padding: 0;
	margin: 0;
	list-style: none;
	padding-top: 2px;
}

.css-treeview input {
	position: absolute;
	opacity: 0
}

.css-treeview {
	font-size: 11px;
	-moz-user-select: none;
	-webkit-user-select: none;
	user-select: none
}

.css-treeview span {
	color: #00f;
	cursor: pointer
}

.css-treeview span:hover {
	text-decoration: underline
}

.css-treeview input+label+ul {
	margin: 0 0 0 22px
}

.css-treeview input~ul {
	display: none
}

.css-treeview label,
.css-treeview label::before {
	cursor: pointer
}

.css-treeview input:disabled+label {
	cursor: default;
	opacity: .6
}

.css-treeview input:checked:not(:disabled)~ul {
	display: block
}

.css-treeview label,
.css-treeview label::before,
.css-treeview span {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAACgCAYAAAAFOewUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAAZdEVYdFNvZnR3YXJlAEFkb2JlIEltYWdlUmVhZHlxyWU8AAAEHElEQVRoQ+2XXWgcVRTH/7tpdrNtarqoXZe06EpTCyJiFYmKHw0UKwj2UfHBB1+KYECwUEFI8pA8SKEPiraIPlsphOIXIoJ5sFgpolRFBEke0som2Thx0+7u7M6M59y5d/bOzuw26SY0yP3ByT1z7z3/OefMzCWb8AgQv3zxGv2twas7fIl0Xx+277pT+DoDe45g154n5BWQlCNSGRcPHjqA7GBWmN2ow1pexrbb7sLdw0cDm//5IxnhEwiA8nBdD3sP5IU98PR+3HP/7bjy2w/A72cD4z06TQHCo0XXdX1zPOwY2C7ma7YDh66ZtgLcCdfxA3VjGjTPxrh+ywK0EmRQwzeHAtiYRoOzWkMGjhaohJhqna75BnTZsQeiBL4bmSONqdYc2HUWJ5H2GdAGEcSj8n2BSq2BKjXSpvnC/odx4ZOXxTwTbqIWWClXUS6tirVrFQf8ftWolNxDb4SyaGkiBdMmtvk/r2D+ryLdPYF0uhc9PT2UhXwScQKqiaoHjFV2sLLaoNS5DBfXyUa/Gw09Si0Dv4l67TaXQg20yjYqdHcWeWW5iuS2HWKdCQSSqRwW5xdDApb1LxYWS1gqLaG4sChs931H8dRLze8h+BoVf3z7uhivrZRxfecRPHn4RXHdjmYJip68b8n0DYOZSAbrJZrBOulaIFTCxMSE9NozNjYmPQkLKMbHx6UXT9z6re9BrEAikYhYO2IFqLSItePW96Dr9+B/8C0YgS1/HnT6ChWb00T9DOjqPGj149icEhSd7qww58EGCAQ94JelUCjAtu3Ii+M4DoaGhjAzMyNnmgQCffQDo1qtisk48vk8/XvnolgsyhmfoIRarSa9eFg8l8sJ01lzD4aHh1EqlZDJZJDNZuUswSUwmntDRkZGpOd5oSayy2M6nQ4ayanLLQFqr/BbBdaCvndj3wN2edRLUPAaPym1R4ZtxRJ6e3uRTCaF6ajfk/V6fYuVEAhw59eKvjdUAjM4OBj4rfDWVCqF2dnZaA9ulo3rwc3StUCkiZ2Ia1coA97QaorHDz0bfxPaJFAuHSBiVPA82/T5zzwSkbNNQgLnP//Se+75F7z3PjgjTM2z/Xjpp8DXCZXwzddfYfrcWVy88L2wubk5uQKcPPUuXj02ioOPPRMqZfMf49sTk8L6d/ZT/h723VuQKxJZSlAb9+D9Dz8WFofqhSIi0Ao/FbbJyUnv6tW/IwIdDxQ+RN88flz4v16+jOwdu/HWiRN49JGDwd5ID6ampmBZljAO5kA25p+lBaxYy8JXhDKg9wCnTr6DTP+AWKysrohRh7OYPvdpfAanT58RIwfGBTOchU5IoF1QJ7p+kdb1OeuoHpgz0QgwRsAIMEbACDBGwAgwRsAIMEbACDBGwAgwRsAIMEbACDBGAPgPluQbnYFDf0MAAAAASUVORK5CYII=) no-repeat;
}

.css-treeview label,
.css-treeview label::before,
.css-treeview span,
.css-treeview span::before {
	display: inline-block;
	height: 16px;
	line-height: 16px;
	vertical-align: middle
}

.css-treeview label {
	background-position: 18px 0
}

.css-treeview span.txt {
	background-position: 18px -48px
}

.css-treeview span.img {
	background-position: 18px -68px
}

.css-treeview label::before {
	content: "";
	width: 16px;
	margin: 0 22px 0 0;
	vertical-align: middle;
	background-position: 0 -32px
}

.css-treeview span::before {
	content: "";
	width: 16px;
	margin: 0 22px 0 0
}

.css-treeview input:checked+label::before {
	background-position: 0 -16px
}

@media screen and (-webkit-min-device-pixel-ratio:0) {
	.css-treeview {
		-webkit-animation: webkit-adjacent-element-selector-bugfix infinite 1s
	}

	@-webkit-keyframes webkit-adjacent-element-selector-bugfix {
		from {
			padding: 0
		}

		to {
			padding: 0
		}
	}
}

#header {
	position: absolute;
	top: 0;
	right: 0;
	left: 0;
	height: 24px;
	padding: 1px 1px 0 10px;
	background-color: #444;
	color: #eee
}

#tree {
	position: absolute;
	top: 25px;
	bottom: 0;
	left: 0;
	width: 20%;
	padding: 8px
}

#editor,
#preview {
	position: absolute;
	top: 25px;
	right: 0;
	bottom: 0;
	left: 20%
}

#preview {
	background-color: #eee;
	padding: 5px
}

#status {
	position: absolute;
	top: 3px;
	right: 10px;
	font-size: 15px
}

#fsMeter {
	width: 100px;
	padding-bottom: 2px
}

#warning {
	height: 100%;
	background-color: orange;
	color: #000
}

.tooltip {
	position: absolute;
	z-index: 2;
	right: 0;
	top: 20px;
	visibility: hidden;
	background-color: #fff;
	color: #000;
	text-align: center;
	border: 1px solid #000;
	padding: 3px;
	font-size: 10px
}

#warning:hover .tooltip {
	visibility: visible
}

#loading {
	position: absolute;
	top: -100vh;
	left: 0;
	width: 100vw;
	height: 100vh;
	z-index: 100;
	background-color: rgba(0, 0, 0, .5);
	opacity: 0;
	transition: opacity .5s ease-in-out
}

#loading.shown {
	top: 0;
	opacity: 1
}

#loading-msg {
	display: inline-block;
	position: absolute;
	top: 0;
	left: 50%;
	transform: translateX(-50%);
	color: #fff;
	font-size: 32px
}

@keyframes spinner-anim {
	0% {
		transform: rotate(0)
	}

	100% {
		transform: rotate(360deg)
	}
}

.spinner-anim:not(:required) {
	display: inline-block;
	position: relative;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	animation: spinner-anim 1s infinite linear;
	border: 16px solid #eee;
	border-right-color: transparent;
	border-radius: 32px;
	box-sizing: border-box;
	overflow: hidden;
	text-indent: -9999px;
	width: 64px;
	height: 64px
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.28.0/src-min-noconflict/ace.min.js"></script>
<script>
// Utility functions
const getElementById = function (id) {
  return document.getElementById(id);
}

const createElement = function (tag) {
  return document.createElement(tag);
}

// Loading indicator functions
function setLoading(isLoading, message = "") {
  const loadingMsg = getElementById("loading-msg");
  loadingMsg.innerHTML = message;
  
  const loadingElement = getElementById("loading");
  if (isLoading) {
    loadingElement.classList.add("shown");
  } else {
    loadingElement.classList.remove("shown");
  }
  
  document.body.style.cursor = isLoading ? "wait" : "default";
}

// File size formatting
function formatFileSize(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  
  const units = ["KiB", "MiB", "GiB", "TiB", "PiB"];
  let unitIndex = -1;
  
  do {
    bytes /= 1024;
    unitIndex++;
  } while (bytes > 1024 && unitIndex < units.length - 1);
  
  return `${bytes.toFixed(2)} ${units[unitIndex]}`;
}

// Status panel management
function refreshStatus() {
  const statusElement = getElementById("status");
  statusElement.innerHTML = "(refreshing...)";
  
  const request = new XMLHttpRequest();
  request.onload = function () {
    if (request.status !== 200) {
      showHttpError(request);
      return;
    }
    
    const fsInfo = JSON.parse(request.responseText);
    let statusText = `${fsInfo.type} - `;
    
    if (fsInfo.isOk) {
      const usedPercentage = 1 + Math.round(99 * fsInfo.usedBytes / fsInfo.totalBytes);
      const sizeInfo = `${formatFileSize(fsInfo.totalBytes - fsInfo.usedBytes)} free of ${formatFileSize(fsInfo.totalBytes)}`;
      
      statusText += `<meter id="fsMeter" min="0" optimum="0" low="90" high="95" max="100" 
                        value="${usedPercentage}" title="${sizeInfo}">${sizeInfo}</meter>`;
      
      if (fsInfo.unsupportedFiles) {
        statusText += ` <span id="warning">WARNING<span class="tooltip">Filesystem contains unsupported filenames:<br/>
                       ${fsInfo.unsupportedFiles}</span></span>`;
      }
    } else {
      statusText += `<span style="background-color:red;color:white;font-weight:bold">INIT ERROR !</span>`;
    }
    
    statusElement.innerHTML = statusText;
    
    if (fsInfo.type !== "SPIFFS") {
      getElementById("mkdir").style.display = "inline";
    }
  };
  
  request.open("GET", "/status", true);
  request.send();
}

function showHttpError(request) {
  alert(`ERROR: [${request.status}] ${request.responseText}`);
}

// Editor state management
function canLoadNewContents() {
  const saveBtn = getElementById("saveBtn");
  if (!saveBtn.disabled) {
    return confirm("Changes to your document will be lost if you continue");
  }
  return true;
}

function enableSaveDiscardButtons(enable) {
  getElementById("saveBtn").disabled = !enable;
  getElementById("discardBtn").disabled = !enable;
}

// Path utilities
function getParentFolder(path) {
  path = path.startsWith("/") ? path : `/${path}`;
  path = path.endsWith("/") ? path.slice(0, -1) : path;
  return path.substring(0, path.lastIndexOf("/"));
}

// Header creation
function createHeader(containerId, treeManager, editor) {
  const container = getElementById(containerId);
  
  // Create file input
  const fileInput = createElement("input");
  fileInput.type = "file";
  fileInput.multiple = false;
  fileInput.name = "data";
  container.appendChild(fileInput);
  
  // Create path input
  const pathInput = createElement("input");
  pathInput.id = "pathInput";
  pathInput.type = "text";
  pathInput.name = "path";
  pathInput.defaultValue = "/";
  container.appendChild(pathInput);
  
  // Create upload button
  const uploadBtn = createElement("button");
  uploadBtn.innerHTML = "Upload";
  container.appendChild(uploadBtn);
  
  // Create mkdir button
  const mkdirBtn = createElement("button");
  mkdirBtn.id = "mkdir";
  mkdirBtn.style.display = "none";
  mkdirBtn.innerHTML = "MkDir";
  container.appendChild(mkdirBtn);
  
  // Create mkfile button
  const mkfileBtn = createElement("button");
  mkfileBtn.innerHTML = "MkFile";
  container.appendChild(mkfileBtn);
  
  // Create editor buttons container
  const editorButtons = createElement("span");
  editorButtons.id = "editorButtons";
  editorButtons.style.display = "none";
  container.appendChild(editorButtons);
  
  // Create save button
  const saveBtn = createElement("button");
  saveBtn.id = "saveBtn";
  saveBtn.innerHTML = "Save";
  saveBtn.style.marginLeft = "30px";
  saveBtn.disabled = true;
  editorButtons.appendChild(saveBtn);
  
  // Create discard button
  const discardBtn = createElement("button");
  discardBtn.id = "discardBtn";
  discardBtn.innerHTML = "Discard";
  discardBtn.disabled = true;
  editorButtons.appendChild(discardBtn);
  
  // Create help button
  const helpBtn = createElement("button");
  helpBtn.id = "helpBtn";
  helpBtn.innerHTML = "?";
  editorButtons.appendChild(helpBtn);
  
  // Create status element
  const statusElement = createElement("span");
  statusElement.id = "status";
  statusElement.innerHTML = "(loading)";
  container.appendChild(statusElement);
  
  // Event handlers
  fileInput.onchange = function() {
    if (fileInput.files.length > 0) {
      const fileName = fileInput.files[0].name;
      let path = pathInput.value;
      
      if (!path.startsWith("/")) {
        path = `/${path}`;
      }
      
      pathInput.value = `${getParentFolder(path)}/${fileName}`;
    }
  };
  
  uploadBtn.onclick = function() {
    if (fileInput.files.length > 0) {
      treeManager.httpUpload(fileInput.files[0], pathInput.value);
    }
  };
  
  mkfileBtn.onclick = function() {
    const path = pathInput.value.trim();
    if (!path) {
      alert("A filename must be given");
    } else if (path.endsWith("/")) {
      alert("Filenames must not end with a '/' character");
    } else {
      treeManager.httpCreate(path);
    }
  };
  
  mkdirBtn.onclick = function() {
    let path = pathInput.value.trim();
    if (!path) {
      alert("A folder name must be given");
    } else {
      if (!path.endsWith("/")) {
        path += "/";
      }
      treeManager.httpCreate(path);
    }
  };
  
  saveBtn.onclick = function() {
    editor.save();
  };
  
  discardBtn.onclick = function() {
    editor.discard();
  };
  
  helpBtn.onclick = function() {
    editor.showShortcuts();
  };
}

// File type detection
function isTextFile(filename) {
  const extension = filename.split('.').pop().toLowerCase();
  console.log(filename, extension);
  const textExtensions = ['txt', 'htm', 'html', 'js', 'json', 'cpp', 'css', 'xml', 'yaml', 'csv'];
  return textExtensions.includes(extension) || extension === filename
}

function isImageFile(filename) {
  const extension = filename.split('.').pop().toLowerCase();
  const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'ico'];
  return imageExtensions.includes(extension);
}

// Context menu creation
function createContextMenu(event, targetId, isFile) {
  const contextMenu = createElement("div");
  contextMenu.className = "contextMenu";
  
  // Position the menu
  const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
  const scrollLeft = document.body.scrollLeft || document.documentElement.scrollLeft;
  const menuX = event.clientX + scrollLeft;
  const menuY = event.clientY + scrollTop;
  
  contextMenu.style.display = "block";
  contextMenu.style.left = `${menuX}px`;
  contextMenu.style.top = `${menuY}px`;
  
  // Create menu items
  const menuList = createElement("ul");
  contextMenu.appendChild(menuList);
  
  if (isFile) {
    // File context menu items
    addMenuItem(menuList, "Rename/Move", function() {
      removeContextMenu();
      const newName = prompt(`Rename ${targetId} to`, targetId);
      if (newName && newName !== targetId) {
        treeManager.renameFile(targetId, newName);
      }
    });
    
    addMenuItem(menuList, "Delete", function() {
      removeContextMenu();
      treeManager.deleteFile(targetId);
    });
  } else {
    // Folder context menu items
    const checkbox = getElementById(targetId).childNodes[0];
    const isChecked = checkbox.checked;
    
    if (isChecked) {
      addMenuItem(menuList, "Collapse", function() {
        removeContextMenu();
        checkbox.checked = false;
      });
      
      addMenuItem(menuList, "Refresh", function() {
        removeContextMenu();
        treeManager.refreshFolder(targetId, event);
      });
    } else {
      addMenuItem(menuList, "Expand", function() {
        removeContextMenu();
        checkbox.checked = true;
        treeManager.refreshFolder(targetId, event);
      });
    }
    
    addMenuItem(menuList, "Rename/Move", function() {
      removeContextMenu();
      const newName = prompt(`Rename ${targetId} to`, targetId);
      if (newName && newName !== targetId) {
        treeManager.renameFile(targetId, newName);
      }
    });
    
    addMenuItem(menuList, "Delete", function() {
      removeContextMenu();
      treeManager.deleteFile(targetId);
    });
  }
  
  document.body.appendChild(contextMenu);
  
  // Handle menu dismissal
  const menuWidth = contextMenu.offsetWidth;
  const menuHeight = contextMenu.offsetHeight;
  
  contextMenu.onmouseout = function(e) {
    if (e.clientX < menuX || e.clientX > menuX + menuWidth || 
        e.clientY < menuY || e.clientY > menuY + menuHeight) {
      removeContextMenu();
    }
  };
  
  function addMenuItem(menu, text, action) {
    const item = createElement("li");
    item.innerHTML = `<span>${text}</span>`;
    item.onclick = action;
    menu.appendChild(item);
  }
  
  function removeContextMenu() {
    const menus = document.body.getElementsByClassName("contextMenu");
    if (menus.length > 0) {
      document.body.removeChild(contextMenu);
    }
  }
}

// Tree manager implementation
function createTreeManager(containerId, editor) {
  const container = getElementById(containerId);
  const previewPanel = getElementById("preview");
  const treeElement = createElement("div");
  
  treeElement.className = "css-treeview";
  treeElement.id = "/";
  container.appendChild(treeElement);
  
  const treeManager = {
    clearMainPanel: function() {
      getElementById("editor").style.display = "none";
      getElementById("editorButtons").style.display = "none";
      previewPanel.style.display = "block";
      previewPanel.innerHTML = "<div style='text-align:center'>(file not found or format not supported)</div>";
    },
    
    attemptLoad: function(path) {
      getElementById("pathInput").value = path;
      
      if (!canLoadNewContents()) return;
      
      if (isTextFile(path)) {
        if (typeof ace === "undefined") {
          loadTextFile(path);
        } else {
          editor.loadUrl(path);
        }
      } else if (isImageFile(path)) {
        loadImageFile(path);
      } else {
        this.clearMainPanel();
      }
    },
    
    refreshPath: function(path) {
      if (fsInfo.type === "SPIFFS") {
        this.refreshFolder("/");
      } else if (path.lastIndexOf("/") === -1) {
        this.refreshFolder("/");
      } else {
        const pathsToRefresh = [];
        let currentPath = path;
        
        while (currentPath.lastIndexOf("/") !== -1 && !getElementById(currentPath)) {
          pathsToRefresh.push(currentPath);
          currentPath = getParentFolder(currentPath);
        }
        
        if (currentPath === "") {
          pathsToRefresh.push("/");
        } else {
          pathsToRefresh.push(currentPath);
        }
        
        this.refreshPathsSequentially(pathsToRefresh);
      }
    },
    
    httpUpload: function(file, path) {
      setLoading(true, `Uploading '${path}'...`);
      
      if (!path.startsWith("/")) {
        path = `/${path}`;
      }
      
      const request = new XMLHttpRequest();
      request.onload = createRequestHandler(request, path);
      
      const formData = new FormData();
      formData.append("data", file, path);
      
      request.open("POST", "/edit");
      request.send(formData);
    },
    
    httpCreate: function(path) {
      setLoading(true, `Creating '${path}'...`);
      
      if (!path.startsWith("/")) {
        path = `/${path}`;
      }
      
      const request = new XMLHttpRequest();
      request.onload = createRequestHandler(request, path);
      
      const formData = new FormData();
      formData.append("path", path);
      
      request.open("PUT", "/edit");
      request.send(formData);
    },
    
    renameFile: function(oldPath, newPath) {
      setLoading(true, `Renaming '${oldPath}' to '${newPath}'...`);
      
      if (!newPath.startsWith("/")) {
        newPath = `/${newPath}`;
      }
      
      const request = new XMLHttpRequest();
      request.onload = createRequestHandler(request, newPath);
      
      const formData = new FormData();
      formData.append("path", newPath);
      formData.append("src", oldPath);
      
      request.open("PUT", "/edit");
      request.send(formData);
    },
    
    deleteFile: function(path) {
      setLoading(true, `Deleting '${path}'...`);
      
      const request = new XMLHttpRequest();
      request.onload = createRequestHandler(request, path);
      
      const formData = new FormData();
      formData.append("path", path);
      
      request.open("DELETE", "/edit");
      request.send(formData);
    },
    
    refreshFolder: function(path, event) {
      setLoading(true, `Listing '${path}'...`);
      
      const request = new XMLHttpRequest();
      request.onload = function() {
        setLoading(false);
        
        if (request.status !== 200) {
          showHttpError(request);
          return;
        }
        
        const folderElement = getElementById(path);
        if (folderElement) {
          const lastChild = folderElement.lastElementChild;
          if (lastChild && lastChild.tagName === "UL") {
            folderElement.removeChild(lastChild);
          }
        }
        
        const items = JSON.parse(request.responseText);
        renderFolderItems(path, items);
        
        getElementById("pathInput").value = path;
        
        const checkbox = getElementById(path)?.childNodes[0];
        if (checkbox && checkbox.checked !== undefined) {
          checkbox.checked = true;
        }
        
        if (event && event.length) {
          refreshPathsSequentially(event);
        }
      };
      
      request.open("GET", `/list?dir=${path}`, true);
      request.send();
    },
    
    refreshPathsSequentially: function(paths) {
      const nextPath = paths.pop();
      if (nextPath) {
        this.refreshFolder(nextPath, paths);
      }
    }
  };
  
  // Helper functions
  function createRequestHandler(request, path) {
    return function() {
      setLoading(false);
      if (request.status !== 200) {
        showHttpError(request);
        return;
      }
      
      const parentPath = getParentFolder(path);
      if (request.responseText && request.responseText !== parentPath) {
        treeManager.refreshPath(request.responseText);
      }
      
      treeManager.refreshPath(parentPath);
      treeManager.attemptLoad(path);
      refreshStatus();
    };
  }
  
  function renderFolderItems(path, items) {
    items.sort((a, b) => {
      if (a.type === b.type) {
        return a.name.localeCompare(b.name);
      }
      return a.type.localeCompare(b.type);
    });
    
    const listElement = createElement("ul");
    const parentElement = getElementById(path);
    parentElement.appendChild(listElement);
    
    items.forEach(item => {
      const listItem = item.type === "file" ? 
        createFileItem(path, item) : 
        createFolderItem(path, item);
      
      listElement.appendChild(listItem);
    });
  }
  
  function createFileItem(parentPath, file) {
    const itemId = `${parentPath === "/" ? "" : parentPath}/${file.name}`;
    const listItem = createElement("li");
    listItem.id = itemId;
    
    const span = createElement("span");
    if (isTextFile(file.name)) {
      span.classList.add("txt");
    } else if (isImageFile(file.name)) {
      span.classList.add("img");
    }
    
    span.innerHTML = `${file.name} <i>(${formatFileSize(file.size)})</i>`;
    listItem.appendChild(span);
    
    listItem.onclick = function() {
      treeManager.attemptLoad(itemId);
    };
    
    listItem.oncontextmenu = function(e) {
      e.preventDefault();
      e.stopPropagation();
      createContextMenu(e, itemId, true);
    };
    
    return listItem;
  }
  
  function createFolderItem(parentPath, folder) {
    const itemId = `${parentPath === "/" ? "" : parentPath}/${folder.name}`;
    const listItem = createElement("li");
    listItem.id = itemId;
    
    const checkbox = createElement("input");
    checkbox.type = "checkbox";
    if (folder.size === undefined) {
      checkbox.disabled = "disabled";
    }
    listItem.appendChild(checkbox);
    
    const label = createElement("label");
    label.textContent = folder.name;
    listItem.appendChild(label);
    
    checkbox.onchange = function() {
      if (checkbox.checked) {
        treeManager.refreshFolder(itemId);
      }
    };
    
    label.onclick = function(e) {
      checkbox.checked = !checkbox.checked;
      if (checkbox.checked) {
        treeManager.refreshFolder(itemId);
      }
    };
    
    listItem.oncontextmenu = function(e) {
      e.preventDefault();
      e.stopPropagation();
      createContextMenu(e, itemId, false);
    };
    
    return listItem;
  }
  
  function loadTextFile(path) {
    getElementById("pathInput").value = path;
    getElementById("editor").style.display = "none";
    getElementById("editorButtons").style.display = "none";
    previewPanel.style.display = "block";
    previewPanel.innerHTML = `<span style='color:red;'>Ace editor could not be loaded from the internet nor from /edit/ace.js . Defaulting to text viewer...</span>
                            <pre id='txtContents' style='overflow: auto;'></pre>`;
    
    const request = new XMLHttpRequest();
    request.onload = function() {
      getElementById("txtContents").textContent = request.responseText;
    };
    request.open("GET", path);
    request.send();
  }
  
  function loadImageFile(path) {
    getElementById("pathInput").value = path;
    getElementById("editor").style.display = "none";
    getElementById("editorButtons").style.display = "none";
    previewPanel.style.display = "block";
    previewPanel.innerHTML = `<img src='${path}' style='max-width:100%; max-height:100%; margin:auto; display:block;' />`;
  }
  
  // Initialize the tree
  treeManager.refreshFolder("/");
  
  return treeManager;
}

// Editor implementation
function createEditor(containerId, initialFile = "/index.htm", initialMode = "plain", 
                     initialTheme = "textmate", initialContentType = "text/plain") {
  const container = getElementById(containerId);
  let currentRequest = null;
  let currentFile = initialFile;
  let currentMode = initialMode;
  let currentContentType = initialContentType;
  
  // Initialize ACE editor
  const editor = ace.edit(container);
  
  function determineFileMode(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    
    switch (extension) {
      case "txt": return "plain";
      case "htm": return "html";
      case "js": return "javascript";
      case "css": case "scss": case "php": case "html": 
      case "json": case "xml": case "yaml": case "csv":
        return extension;
      default: return "plain";
    }
  }
  
  function handleFileLoad() {
    setLoading(false);
    getElementById("preview").style.display = "none";
    getElementById("editor").style.display = "block";
    getElementById("editorButtons").style.display = "inline";
    
    if (currentRequest.status === 200) {
      editor.setValue(currentRequest.responseText);
      editor.clearSelection();
      enableSaveDiscardButtons(false);
    } else {
      treeManager.clearMainPanel();
    }
  }
  
  function loadFile(path) {
    setLoading(true, `Loading '${path}'...`);
    
    currentRequest = new XMLHttpRequest();
    currentRequest.onload = handleFileLoad;
    currentRequest.open("GET", path, true);
    currentRequest.send();
  }
  
  function handleFileSave() {
    setLoading(false);
    if (currentRequest.status !== 200) {
      showHttpError(currentRequest);
      return;
    }
    
    treeManager.refreshPath(getParentFolder(currentFile));
    refreshStatus();
  }
  
  function saveFile() {
    enableSaveDiscardButtons(false);
    
    setLoading(true, `Saving '${currentFile}'...`);
    currentRequest = new XMLHttpRequest();
    currentRequest.onload = handleFileSave;
    
    const formData = new FormData();
    formData.append("data", new Blob([editor.getValue() + ""], {
      type: currentContentType
    }), currentFile);
    
    currentRequest.open("POST", "/edit");
    currentRequest.send(formData);
  }
  
  // Configure editor
  if (currentMode !== "plain") {
    editor.getSession().setMode(`ace/mode/${currentMode}`);
  }
  
  editor.setTheme(`ace/theme/${initialTheme}`);
  editor.$blockScrolling = Infinity;
  editor.getSession().setUseSoftTabs(true);
  editor.getSession().setTabSize(2);
  editor.setHighlightActiveLine(true);
  editor.setShowPrintMargin(false);
  
  // Add editor commands
  editor.commands.addCommand({
    name: "save",
    bindKey: { win: "Ctrl-S", mac: "Command-S" },
    exec: function(editor) { editor.save(); },
    readOnly: false
  });
  
  editor.commands.addCommand({
    name: "showKeyboardShortcuts",
    bindKey: { win: "Ctrl-Alt-h", mac: "Command-Alt-h" },
    exec: function(editor) { editor.showShortcuts(); }
  });
  
  // Event listeners
  editor.session.on("change", function() {
    enableSaveDiscardButtons(true);
  });
  
  // Public methods
  editor.loadUrl = function(path) {
    getElementById("pathInput").value = path;
    enableSaveDiscardButtons(false);
    
    currentFile = path;
    currentMode = determineFileMode(path);
    currentContentType = `text/${currentMode}`;
    
    if (currentMode !== "plain") {
      editor.getSession().setMode(`ace/mode/${currentMode}`);
    }
    
    loadFile(path);
  };
  
  editor.save = saveFile;
  
  editor.discard = function() {
    this.loadUrl(currentFile);
    enableSaveDiscardButtons(false);
  };
  
  editor.showShortcuts = function() {
    ace.config.loadModule("ace/ext/keybinding_menu", function(module) {
      module.init(editor);
      editor.showKeyboardShortcuts();
    });
  };
  
  // Load initial file
  loadFile(currentFile);
  
  return editor;
}

// Global variables
let treeManager;
let fsInfo;

// Initialization
function onBodyLoad() {
  // Parse URL parameters
  const urlParams = {};
  window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(match, key, value) {
    urlParams[key] = value;
  });
  
  // Initialize editor if ACE is available
  let editor;
  if (typeof ace !== "undefined") {
    editor = createEditor(
      "editor", 
      urlParams.file, 
      urlParams.lang, 
      urlParams.theme
    );
  }
  
  // Create UI components
  createHeader("header", treeManager = createTreeManager("tree", editor), editor);
  refreshStatus();
}

// Fallback for ACE editor loading
if (typeof ace === "undefined") {
  console.log("Cannot load ace.js from the web, trying local copy");
  const script = createElement("script");
  script.src = "/edit/ace.js";
  script.async = false;
  document.head.appendChild(script);
}
</script>


<body onload=onBodyLoad()>
    <div id=header></div>
    <div id=tree></div>
    <div id=editor></div>
    <div id=preview style=display:none></div>
    <div id=loading><span id=loading-msg></span>
        <br>
        <div class=spinner-anim>Loading...</div>
    </div>
</body>
</html>